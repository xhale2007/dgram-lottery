<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnChainDraws - Win Big on the Blockchain!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4a90e2 0%, #667eea 50%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1a1a2e;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
        }

        .logo-container {
            margin-bottom: 20px;
        }

        .logo {
            max-width: 450px;
            width: 100%;
            height: auto;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .subtitle {
            font-size: 1.3em;
            opacity: 0.95;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-top: 10px;
            color: #1a1a2e;
            font-weight: 600;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #4a90e2 0%, #667eea 50%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .btn {
            background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .wallet-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .wallet-address {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            margin-top: 10px;
            word-break: break-all;
        }

        .contract-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .contract-address {
            font-family: monospace;
            word-break: break-all;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .players-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .player-entry {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            font-family: monospace;
            font-size: 0.9em;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #155724;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #856404;
            color: #856404;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .prize-breakdown {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe0b2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #ff9800;
        }

        .prize-breakdown h3 {
            color: #e65100;
            margin-bottom: 15px;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .prize-item:last-child {
            border-bottom: none;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        #status {
            min-height: 20px;
            margin: 10px 0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal-content h3 {
            color: #333;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .modal-content p, .modal-content ul, .modal-content ol {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .modal-content ul, .modal-content ol {
            padding-left: 20px;
        }

        .modal-content li {
            margin-bottom: 8px;
            color: #333;
        }

        .modal-content strong {
            color: #333;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .warning-box strong {
            color: #ff9800;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-top: 5px;
            cursor: pointer;
        }

        .checkbox-container label {
            cursor: pointer;
            font-weight: normal;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
        }

        /* Decorative elements */
        h2 {
            color: #1a1a2e;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        @media (max-width: 768px) {
            .logo {
                max-width: 300px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Terms Modal -->
        <div id="termsModal" class="modal">
            <div class="modal-content">
                <h2>‚ö†Ô∏è Terms and Conditions</h2>
                
                <h3>Educational Purpose Only</h3>
                <p>This lottery smart contract is provided <strong>for educational and entertainment purposes only</strong>. By participating, you acknowledge that this is an experimental decentralized application (dApp) demonstrating blockchain technology and smart contract functionality.</p>

                <h3>Pseudo-Random Number Generation</h3>
                <p>This lottery uses <strong>pseudo-random number generation</strong> based on blockchain data sources including:</p>
                <ul>
                    <li>Block timestamp and block number</li>
                    <li>Avalanche's prevrandao (randomness beacon)</li>
                    <li>Previous block hash</li>
                    <li>Player addresses and contract state</li>
                </ul>
                <p>While this method provides sufficient unpredictability for educational purposes and small-scale lotteries, it is <strong>not cryptographically provable</strong> like Chainlink VRF or similar oracle-based solutions.</p>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Important:</strong> This is NOT a true random number generator. For high-stakes applications, use oracle-based randomness solutions.
                </div>

                <h3>Decentralized & Non-Custodial</h3>
                <p>This lottery is <strong>fully decentralized</strong>:</p>
                <ul>
                    <li>No one controls the smart contract after deployment</li>
                    <li>Winner selection is automatic and deterministic</li>
                    <li>All code is open-source and verifiable on-chain</li>
                    <li>No central authority can manipulate results</li>
                    <li>You maintain full custody of your funds until you choose to participate</li>
                </ul>

                <h3>How It Works</h3>
                <ol>
                    <li>10 players each send 100 DGRAM to enter</li>
                    <li>When the 10th player enters, a winner is automatically selected</li>
                    <li>Winner receives 900 DGRAM (90%)</li>
                    <li>50 DGRAM is burned (5%)</li>
                    <li>50 DGRAM goes to platform maintenance (5%)</li>
                </ol>

                <h3>Risks & Disclaimers</h3>
                <ul>
                    <li><strong>Smart Contract Risk:</strong> While tested, smart contracts may contain bugs</li>
                    <li><strong>No Guarantees:</strong> Blockchain transactions are irreversible</li>
                    <li><strong>Gas Fees:</strong> You pay network gas fees in addition to entry fee</li>
                    <li><strong>Regulatory:</strong> Online gambling may be restricted in your jurisdiction</li>
                    <li><strong>Loss of Funds:</strong> Only participate with funds you can afford to lose</li>
                    <li><strong>No Customer Support:</strong> This is a decentralized application with no support team</li>
                </ul>

                <h3>Your Responsibilities</h3>
                <p>By participating, you confirm that:</p>
                <ul>
                    <li>You are of legal age in your jurisdiction</li>
                    <li>You understand blockchain technology and smart contracts</li>
                    <li>You have read and understood these terms</li>
                    <li>You accept all risks associated with participation</li>
                    <li>You comply with all applicable laws in your jurisdiction</li>
                </ul>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Participate at Your Own Risk:</strong> The contract creator and website operator assume no liability for any losses. This is experimental software.
                </div>

                <div class="checkbox-container">
                    <input type="checkbox" id="acceptTerms">
                    <label for="acceptTerms">
                        I have read, understood, and agree to these terms and conditions. I understand this is for educational purposes only and uses pseudo-random number generation. I accept all risks and understand that no one can manipulate the decentralized lottery results.
                    </label>
                </div>

                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="declineTerms()">Decline & Exit</button>
                    <button class="btn" id="acceptTermsBtn" disabled onclick="acceptTerms()">Accept & Continue</button>
                </div>
            </div>
        </div>

        <header>
            <div class="logo-container">
                <img src="onchaindraws_logo.png" alt="OnChainDraws" class="logo">
            </div>
            <p class="subtitle">üé≤ Enter for a chance to win 900 DGRAM! üé≤</p>
        </header>

        <div class="card">
            <div class="wallet-section">
                <button id="connectBtn" class="btn">üîó Connect MetaMask</button>
                <div id="walletInfo" style="display: none;">
                    <p><strong>Connected Wallet:</strong></p>
                    <div class="wallet-address" id="walletAddress"></div>
                    <p style="margin-top: 10px;"><strong>Your DGRAM Balance:</strong> <span id="balance">0</span> DGRAM</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üé∞ Current Lottery Status</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Current Round</div>
                    <div class="stat-value" id="lotteryId">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Players Entered</div>
                    <div class="stat-value" id="playerCount">0/10</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Current Pot</div>
                    <div class="stat-value" id="potSize">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Your Entries</div>
                    <div class="stat-value" id="myEntries">0</div>
                </div>
            </div>

            <div id="lotteryStatus"></div>

            <div class="input-group">
                <label for="entryCount">Number of Entries (100 DGRAM each):</label>
                <input type="number" id="entryCount" min="1" max="10" value="1">
            </div>

            <button id="enterBtn" class="btn" disabled>
                üéØ Enter Lottery (Send DGRAM)
            </button>

            <div id="status"></div>

            <div class="prize-breakdown">
                <h3>üí∞ Prize Breakdown (Per Round)</h3>
                <div class="prize-item">
                    <span>Entry Fee:</span>
                    <strong>100 DGRAM</strong>
                </div>
                <div class="prize-item">
                    <span>Total Pot:</span>
                    <strong>1,000 DGRAM</strong>
                </div>
                <div class="prize-item">
                    <span>Winner Prize (90%):</span>
                    <strong style="color: #28a745;">900 DGRAM</strong>
                </div>
                <div class="prize-item">
                    <span>Burned (5%):</span>
                    <strong>50 DGRAM</strong>
                </div>
                <div class="prize-item">
                    <span>Platform Fee (5%):</span>
                    <strong>50 DGRAM</strong>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üë• Current Players</h2>
            <div id="playersList" class="players-list">
                <p style="text-align: center; color: #999;">No players yet. Be the first!</p>
            </div>
        </div>

        <div class="card">
            <h2>üèÜ Recent Winners</h2>
            <div id="winnersHistory" class="players-list">
                <p style="text-align: center; color: #999;">No winners yet...</p>
            </div>
        </div>

        <div class="card contract-info">
            <h3>üìã Contract Information</h3>
            <p><strong>Lottery Contract Address:</strong></p>
            <div class="contract-address" id="contractAddress">
                Configure contract address in the code
            </div>
            <p style="margin-top: 15px;"><em>DGRAM is the native token - no token contract needed!</em></p>
        </div>
    </div>

    <script>
        // CONFIGURATION - UPDATE THESE VALUES AFTER DEPLOYMENT
        const CONFIG = {
            LOTTERY_CONTRACT: '0x2845Dd10cE6a8E2CB3AEEb4c9593079d56592316',
            CHAIN_ID: '0x3C8', // 968 in hex
            RPC_URL: 'https://mainnet.datagram.network/rpc',
            EXPLORER_URL: 'https://explorer.datagram.network',
            CHAIN_NAME: 'Datagram Network'
        };

        const ENTRY_FEE = ethers.parseEther('100'); // 100 DGRAM

        // ABIs
        const LOTTERY_ABI = [
            "function enterLottery() external payable",
            "function getPlayers() external view returns (address[])",
            "function getPlayerCount() external view returns (uint256)",
            "function getPlayerEntries(address) external view returns (uint256)",
            "function lotteryId() external view returns (uint256)",
            "function lotteryInProgress() external view returns (bool)",
            "function getContractBalance() external view returns (uint256)",
            "event PlayerEntered(address indexed player, uint256 lotteryId, uint256 entryNumber)",
            "event WinnerSelected(address indexed winner, uint256 amount, uint256 lotteryId)"
        ];

        let provider, signer, lotteryContract, userAddress;
        let termsAccepted = false;

        // Check if terms already accepted (stored in session)
        window.addEventListener('DOMContentLoaded', () => {
            const accepted = sessionStorage.getItem('termsAccepted');
            if (!accepted) {
                document.getElementById('termsModal').style.display = 'block';
            } else {
                termsAccepted = true;
            }
        });

        // Enable accept button when checkbox is checked
        document.getElementById('acceptTerms').addEventListener('change', function() {
            document.getElementById('acceptTermsBtn').disabled = !this.checked;
        });

        // Accept terms
        function acceptTerms() {
            const checkbox = document.getElementById('acceptTerms');
            if (checkbox.checked) {
                termsAccepted = true;
                sessionStorage.setItem('termsAccepted', 'true');
                document.getElementById('termsModal').style.display = 'none';
            }
        }

        // Decline terms
        function declineTerms() {
            alert('You must accept the terms to use this lottery. The page will now close.');
            window.close();
            // If window.close() doesn't work (some browsers block it), redirect away
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 100);
        }

        // Connect MetaMask
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Check network
                const network = await provider.getNetwork();
                console.log('Connected to network:', network);
                console.log('Chain ID:', network.chainId.toString());
                console.log('Expected Chain ID:', CONFIG.CHAIN_ID);
                
                // Verify we're on the right network
                const expectedChainId = parseInt(CONFIG.CHAIN_ID, 16);
                if (network.chainId.toString() !== expectedChainId.toString()) {
                    showStatus(`Wrong network! Please switch to ${CONFIG.CHAIN_NAME}`, 'warning');
                    await switchNetwork();
                    // Refresh after network switch
                    location.reload();
                    return;
                }

                lotteryContract = new ethers.Contract(CONFIG.LOTTERY_CONTRACT, LOTTERY_ABI, signer);

                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('walletAddress').textContent = userAddress;
                document.getElementById('contractAddress').textContent = CONFIG.LOTTERY_CONTRACT;

                document.getElementById('enterBtn').disabled = false;

                await updateUI();
                setupEventListeners();
                loadWinnersHistory(); // Load initial winners history
                showStatus('Connected successfully!', 'success');
            } catch (error) {
                console.error(error);
                showStatus('Error connecting: ' + error.message, 'error');
            }
        });

        // Switch to Datagram Network
        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CONFIG.CHAIN_ID }],
                });
            } catch (error) {
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: CONFIG.CHAIN_ID,
                            chainName: CONFIG.CHAIN_NAME,
                            rpcUrls: [CONFIG.RPC_URL],
                            nativeCurrency: {
                                name: 'DGRAM',
                                symbol: 'DGRAM',
                                decimals: 18
                            },
                            blockExplorerUrls: [CONFIG.EXPLORER_URL]
                        }],
                    });
                }
            }
        }

        // Enter lottery with native DGRAM
        document.getElementById('enterBtn').addEventListener('click', async () => {
            try {
                // Check if terms accepted
                if (!termsAccepted) {
                    document.getElementById('termsModal').style.display = 'block';
                    showStatus('Please accept the terms and conditions first', 'warning');
                    return;
                }

                const entries = parseInt(document.getElementById('entryCount').value) || 1;
                const totalCost = ENTRY_FEE * BigInt(entries);
                
                // Check balance
                const balance = await provider.getBalance(userAddress);
                if (balance < totalCost) {
                    showStatus(`Insufficient balance! You need ${ethers.formatEther(totalCost)} DGRAM`, 'warning');
                    return;
                }

                showStatus(`Entering lottery with ${entries} entries...`, 'info');
                
                // Enter multiple times if requested
                for (let i = 0; i < entries; i++) {
                    const tx = await lotteryContract.enterLottery({ value: ENTRY_FEE });
                    showStatus(`Entry ${i+1}/${entries}: Waiting for confirmation...`, 'info');
                    await tx.wait();
                }
                
                showStatus(`Successfully entered ${entries} time(s)! Good luck! üçÄ`, 'success');
                await updateUI();
            } catch (error) {
                console.error(error);
                showStatus('Error entering lottery: ' + error.message, 'error');
            }
        });

        // Update UI
        async function updateUI() {
            try {
                // Get balance first to debug
                console.log('=== BALANCE DEBUG ===');
                const balance = await provider.getBalance(userAddress);
                console.log('Raw balance:', balance.toString());
                console.log('Formatted balance:', ethers.formatEther(balance));
                
                console.log('=== CONTRACT DEBUG ===');
                console.log('Contract address:', CONFIG.LOTTERY_CONTRACT);
                console.log('User address:', userAddress);
                
                // Check if contract exists
                const code = await provider.getCode(CONFIG.LOTTERY_CONTRACT);
                console.log('Contract code exists:', code !== '0x');
                
                if (code === '0x') {
                    showStatus('ERROR: Contract not found at this address! Check your CONTRACT address in CONFIG.', 'error');
                    return;
                }
                
                // Try to call contract functions one by one to see which fails
                console.log('Calling lotteryId()...');
                const lotteryId = await lotteryContract.lotteryId();
                console.log('‚úì lotteryId:', lotteryId.toString());
                
                console.log('Calling getPlayerCount()...');
                const playerCount = await lotteryContract.getPlayerCount();
                console.log('‚úì playerCount:', playerCount.toString());
                
                console.log('Calling getPlayers()...');
                const players = await lotteryContract.getPlayers();
                console.log('‚úì players:', players);
                
                console.log('Calling getPlayerEntries()...');
                const myEntries = await lotteryContract.getPlayerEntries(userAddress);
                console.log('‚úì myEntries:', myEntries.toString());
                
                console.log('Calling lotteryInProgress()...');
                const inProgress = await lotteryContract.lotteryInProgress();
                console.log('‚úì inProgress:', inProgress);

                document.getElementById('lotteryId').textContent = lotteryId.toString();
                document.getElementById('playerCount').textContent = `${playerCount}/10`;
                document.getElementById('potSize').textContent = `${Number(playerCount) * 100} DGRAM`;
                document.getElementById('myEntries').textContent = myEntries.toString();
                
                // Format balance properly
                const formattedBalance = ethers.formatEther(balance);
                document.getElementById('balance').textContent = parseFloat(formattedBalance).toFixed(4);
                console.log('Displayed balance:', parseFloat(formattedBalance).toFixed(4));

                // Update lottery status
                const statusDiv = document.getElementById('lotteryStatus');
                if (inProgress) {
                    statusDiv.innerHTML = '<div class="alert alert-warning">‚è≥ Drawing winner... Please wait for Chainlink VRF to select the winner!</div>';
                } else if (playerCount == 10) {
                    statusDiv.innerHTML = '<div class="alert alert-info">üé≤ Lottery full! Requesting random number...</div>';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-info">üì¢ ${10 - Number(playerCount)} more ${10 - Number(playerCount) === 1 ? 'player' : 'players'} needed to start the draw!</div>`;
                }

                // Update players list
                const playersList = document.getElementById('playersList');
                if (players.length === 0) {
                    playersList.innerHTML = '<p style="text-align: center; color: #999;">No players yet. Be the first!</p>';
                } else {
                    playersList.innerHTML = players.map((addr, idx) => `
                        <div class="player-entry">
                            <span>Entry #${idx + 1}</span>
                            <span>${addr.substring(0, 6)}...${addr.substring(38)}</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error updating UI:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            lotteryContract.on('PlayerEntered', async (player, lotteryId, entryNumber) => {
                await updateUI();
                if (player.toLowerCase() === userAddress.toLowerCase()) {
                    showStatus(`Entry confirmed! You are entry #${entryNumber}`, 'success');
                }
            });

            lotteryContract.on('WinnerSelected', async (winner, amount, lotteryId) => {
                await updateUI();
                await loadWinnersHistory();
                const formattedAmount = ethers.formatEther(amount);
                if (winner.toLowerCase() === userAddress.toLowerCase()) {
                    showStatus(`üéâ CONGRATULATIONS! You won ${formattedAmount} DGRAM in Round #${lotteryId}!`, 'success');
                } else {
                    showStatus(`Winner selected for Round #${lotteryId}: ${winner.substring(0, 6)}...${winner.substring(38)} won ${formattedAmount} DGRAM`, 'info');
                }
            });
        }

        // Load winners history from events
        async function loadWinnersHistory() {
            try {
                const currentBlock = await provider.getBlockNumber();
                const fromBlock = Math.max(0, currentBlock - 10000); // Last ~10k blocks
                
                const filter = lotteryContract.filters.WinnerSelected();
                const events = await lotteryContract.queryFilter(filter, fromBlock, currentBlock);
                
                const winnersDiv = document.getElementById('winnersHistory');
                
                if (events.length === 0) {
                    winnersDiv.innerHTML = '<p style="text-align: center; color: #999;">No winners yet...</p>';
                    return;
                }
                
                // Reverse to show most recent first
                const recentEvents = events.reverse().slice(0, 10); // Show last 10 winners
                
                winnersDiv.innerHTML = recentEvents.map(event => {
                    const winner = event.args.winner;
                    const amount = ethers.formatEther(event.args.amount);
                    const roundId = event.args.lotteryId.toString();
                    const isYou = winner.toLowerCase() === userAddress.toLowerCase();
                    
                    return `
                        <div class="player-entry" style="${isYou ? 'background: #d4edda; border-left: 4px solid #28a745;' : ''}">
                            <div>
                                <strong>Round #${roundId}</strong><br>
                                <span style="font-size: 0.85em;">${winner.substring(0, 10)}...${winner.substring(34)}</span>
                                ${isYou ? '<span style="color: #28a745; font-weight: bold;"> (YOU!)</span>' : ''}
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: #667eea;">${parseFloat(amount).toFixed(0)} DGRAM</strong>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading winners history:', error);
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-warning' : 'alert-info';
            statusDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Update UI every 10 seconds
        setInterval(() => {
            if (lotteryContract) {
                updateUI();
            }
        }, 10000);
    </script>
</body>
</html>
